name: GitHub Actions Demo
run-name: ${{ github.actor }} is Deploying the Web App
on: [push]
env:
    APP_TAG: ghcr.io/nicolas-gatien/mcdi
    PAT: ${{ secrets.PAT }}
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
            - run: echo ${{ secrets.PAT }} | docker login ghcr.io -u ${{ secrets.USERNAME }} --password-stdin
            - run: docker build -t $APP_TAG .
            - run: docker push $APP_TAG:latest

    deploy:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - run: echo ${{ secrets.PAT }} | docker login ghcr.io -u ${{ secrets.USERNAME }} --password-stdin
            - run: docker pull $APP_TAG:latest
            - name: Prepare SSH Folder
              run: |
                    mkdir -p ~/.ssh
                    chmod 700 ~/.ssh
                    ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
                    chmod 644 ~/.ssh/known_hosts
            - name: Setup SSH Agent
              uses: webfactory/ssh-agent@v0.9.0
              with:
                ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
            - name: SSH Connect
              run: ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "echo 'Connected successfully'"


