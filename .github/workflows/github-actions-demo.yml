name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
on: [push]
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Create SSH key
              run: |
                mkdir -p ~/.ssh/
                echo "$SSH_PRIVATE_KEY" > ../private.key
                sudo chmod 600 ../private.key
                echo "$SSH_PUBLIC_KEY" > ~/.ssh/known_hosts
                shell: bash
                env:
                SSH_PRIVATE_KEY: ${{secrets.SSH_PRIVATE_KEY}}
                SSH_KNOWN_HOSTS: ${{secrets.SSH_PUBLIC_KEY}}
                SSH_KEY_PATH: ${{ github.workspace }}/../private.key
            - run: ssh -i $SSH_KEY_PATH root@${{ secrets.SERVER_IP }}
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
            - name: Check Out the Code
              uses: actions/checkout@v4
            - name: Build & Export
              uses: docker/build-push-action@v6
              with:
                tags: mcd-index:latest
                outputs: type=docker,dest=/tmp/mcd-index.tar
            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                name: mcd-index
                path: /tmp/mcd-index.tar

    deploy:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Download Artifact
              uses: actions/download-artifact@v4
              with:
                name: mcd-index
                path: /tmp
            
            - name: Load Image
              run: |
                docker load --input /tmp/mcd-index.tar
                docker image ls -a


