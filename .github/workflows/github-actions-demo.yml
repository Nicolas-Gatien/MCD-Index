name: GitHub Actions Demo
run-name: ${{ github.actor }} is Deploying the Web App
on: [push]
env:
    APP_TAG: ghcr.io/nicolas-gatien/mcdi
    PAT: ${{ secrets.PAT }}
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v4
            - run: echo ${{ secrets.PAT }} | docker login ghcr.io -u ${{ secrets.USERNAME }} --password-stdin
            - run: docker build -t $APP_TAG .
            - run: docker push $APP_TAG:latest

    deploy:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - run: echo ${{ secrets.PAT }} | docker login ghcr.io -u ${{ secrets.USERNAME }} --password-stdin
            - run: docker pull $APP_TAG:latest
            - run: eval `ssh-agent`
            - run: mkdir ~/.ssh
            - run: ssh-add - <<< "${{ secrets.SSH_PRIVATE_KEY }}"
            - run: ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
            - run: ssh -v ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}



